# Розвідувальний аналіз даних

## Імпорт бібліотек

```{python}
import pandas as pd
import numpy as np
import datetime
import matplotlib.pyplot as plt
import ptitprince as pt
import seaborn as sns
import joypy
import plotly.express as px
from plotnine import *

import warnings
warnings.filterwarnings("ignore")
```

## Вхідні дані

У роботі використаний набір даних, отриманий за допомогою парсингу маркетплейсу Autoria за 10 вересня 2022 року: <https://auto.ria.com/uk>. Даний сайт працює як віртуальний торговельний майданчик із загальнодоступними оголошеннями про продаж автомобілів разом з інформацією про їх характеристики.

Опис змінних:

1. `Brand` – марка автомобіля;
1. `Model` – модель автомобіля;
1. `Year` – рік випуску автомобіля;
1. `Price` – ціна автомобіля (дол.);
1. `Mileage` – пробіг автомобіля (тис. км.);
1. `Location` – фізичне місце розташування автомобіля (включає в себе міста, села, поселення міського типу);
1. `Region` - регіон розташування автомобіля;
1. `Fuel type` – тип палива автомобіля;
1. `Engine volume` – об‘єм двигуна автомобіля (л.);
1. `Gearbox type` – тип коробки передач автомобіля;
1. `Wheel drive` – тип приводу автомобіля;
1. `Accident` – ДТП (потрапляв автомобіль в ДТП чи ні);
1. `VIN-code` – VIN-code (перевірений VIN-code чи ні);
1. `Desc` – опис оголошення.

```{python}
#| column: screen-inset-shaded
#| tbl-cap: 'Вхідні дані'
df = pd.read_csv('00_data/ukr_cars.csv', skipinitialspace = True)
df.head()
```

```{python}
df.info()
```

```{python}
df.describe()
```

```{python}
df.isna().sum()
```

```{python}
# for col in df:
#     print(col)
#     print(df[col].unique())
#     print('\n')
```

```{python}
#| column: screen-inset-shaded
df['Age'] = datetime.date.today().year - df['Year']
df['Price_log'] = df['Price'].apply(lambda x: np.log(x))
df['Region'] = df['Region'].str.replace(' область', '')
df.head()
```

```{python}
df["Brand"].nunique()
```


```{python}
df['Brand'].value_counts().head()
```

```{python}
#| column: screen-inset-shaded
#| layout-nrow: 1

df_counts = df["Brand"].value_counts().iloc[:25].reset_index()
df_counts.columns = ["Brand", "count"]

fig = px.bar(df_counts, y="Brand", x="count", orientation="h")
fig.update_layout(yaxis={'categoryorder':'total ascending'})

fig.update_layout(xaxis_title="Кількість", yaxis_title="", plot_bgcolor='rgba(0,0,0,0)')
fig.show()

df_counts = df["Brand"].value_counts().iloc[:-50:-1].reset_index()
df_counts.columns = ["Brand", "count"]

fig = px.bar(df_counts, y="Brand", x="count", orientation="h")
fig.update_layout(yaxis={'categoryorder':'total descending'})

fig.update_layout(xaxis_title="Кількість", yaxis_title="", plot_bgcolor='rgba(0,0,0,0)')
fig.show()
```

```{python}
def get_top_models(df, brand, top_n=5):
    # Відфільтровуємо за брендом
    df_brand = df[df["Brand"] == brand]
    
    # Згрупуємо за моделлю та порахуємо кількість
    model_counts = df_brand.groupby(by=["Model"]).size().reset_index(name="Count")

    # Відсортуємо та обмежимо результат до top_n найпопулярніших моделей
    top_models = model_counts.nlargest(top_n, "Count")
    
    return top_models
```

```{python}
top5_vw_models = get_top_models(df, "Volkswagen")
top5_bmw_models = get_top_models(df, "BMW")
top5_mers_models = get_top_models(df, "Mercedes-Benz")
```


```{python}
#| layout-ncol: 3
#| fig-cap: 
#|   - "Volkswagen"
#|   - "BMW"
#|   - "Mercedes-Benz"
#| column: page
volk = sns.catplot(y='Model', x='Count', data=top5_vw_models, kind='bar',
palette='PRGn', alpha=0.5, legend=False)
volk.set(xlabel='Кількість', ylabel='Модель автомобіля', title='Volkswagen')
volk.fig.suptitle("")

bmw = sns.catplot(y='Model', x='Count', data=top5_bmw_models, kind='bar',
palette='Spectral', alpha=0.5, legend=False)
bmw.set(xlabel='Кількість', ylabel='Модель автомобіля', title='BMW')
bmw.fig.suptitle("")

mb = sns.catplot(y='Model', x='Count', data=top5_mers_models, kind='bar',
palette='BrBG', alpha=0.5, legend=False)
mb.set(xlabel='Кількість', ylabel='Модель автомобіля', title='Mercedes-Benz')
mb.fig.suptitle("")
plt.show()
```

```{python}
uaRegionsGrid = pd.DataFrame({
'row': [1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 5, 5],
'col': [2, 5, 6, 7, 1, 2, 3, 4, 5, 6, 7, 8, 1, 2, 3, 4, 5, 6, 7, 8, 2, 5, 6, 7, 4, 6, 5],
'code': list(range(1, 28)),
'name': ["Волинська", "Київ", "Чернігівська", "Сумська", "Львівська", "Тернопільська", "Рівненська", "Житомирська", "Київська", "Полтавська", "Харківська", "Луганська", "Закарпатська", "Івано-Франківська", "Хмельницька", "Вінницька", "Черкаська", "Кіровоградська", "Дніпропетровська", "Донецька", "Чернівецька", "Миколаївська", "Херсонська", "Запорізька", "Одеська", "АР Крим", "м. Севастополь"]
})

data_region_quantity = df.groupby('Region').size().reset_index(name='Count')
data_region_quantity['Percent'] = (data_region_quantity['Count'] / data_region_quantity['Count'].sum()) * 100
uaCarsQuantity = uaRegionsGrid.merge(data_region_quantity, left_on='name', right_on='Region', how='left')
```

```{python}
#| fig-cap: "Відсоток представлених автомобілів в регіонах України"
data = np.asarray(uaCarsQuantity.pivot("row", "col", "Percent"))
text = np.asarray(uaCarsQuantity.pivot("row", "col", "Region"))
labels = (np.asarray(["{0}\n{1:.2f}".format(text,data) for text, data in zip(text.flatten(), data.flatten())])).reshape(5,8)

sns.set_theme(style='white', font_scale=0.6)
f, ax = plt.subplots(figsize=(9, 6))
sns.heatmap(data,
    annot=labels,
    linewidths=.5,
    fmt='',
    ax=ax,
    yticklabels=False,
    xticklabels=False,
    cbar=False)
plt.show()
```

```{python}
dx = "GearboxType"; dy = "Price_log"; dhue = "GearboxType"; pal = "Set2"; sigma = 0.2; ort = "h"
f, ax = plt.subplots(figsize=(9, 6))

ax=pt.RainCloud(x = dx, y = dy, data = df, bw = sigma, width_viol = .7,
                ax = ax, orient = ort , alpha = .65, linewidth=0.5, dodge = True, pointplot = True, move = .2)
```


```{python}
labels=[y if y%5==0 else None for y in list(df.Age.unique())]
fig, axes = joypy.joyplot(df, by="Age", column="Price_log", labels=labels, range_style='own', 
                          grid="y", linewidth=1, legend=False, fade=True, figsize=(6,5),
                          title="Вартість автомобілів по рокам\n(ln(Price))",
                          kind="counts", bins=50)
```